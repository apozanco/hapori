Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-opt-scorpion

%files
    planners/ipc2018-opt-scorpion /planner/planners/ipc2018-opt-scorpion

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python

    ## Build planner.
    cd /planner/planners/ipc2018-opt-scorpion
    ./build.py release64

    ## Build h2-mutexes preprocessor.
    mkdir -p builds/h2-mutexes/
    cd builds/h2-mutexes/
    cmake ../../h2-mutexes/
    make -j4

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-opt-scorpion/builds/release64/bin/downward \
        /planner/planners/ipc2018-opt-scorpion/builds/h2-mutexes/bin/preprocess


Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-opt-complementary2

%files
    planners/ipc2018-opt-complementary2  /planner/planners/ipc2018-opt-complementary2

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python autotools-dev automake gcc g++-multilib

    ## Build the planner
    cd /planner/planners/ipc2018-opt-complementary2
    ./build.py release64 -j8

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-opt-complementary2/builds/release64/bin/downward

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-opt-delfi

%files
    planners/ipc2018-opt-delfi /planner/planners/ipc2018-opt-delfi

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends python cmake g++ make

    ## Build planner.
    cd /planner/planners/ipc2018-opt-delfi
    ./build.py release64 -j4

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-opt-delfi/builds/release64/bin/downward \
        /planner/planners/ipc2018-opt-delfi/builds/release64/bin/preprocess

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-symple1

%files
    planners/ipc2018-symple1 /planner/planners/ipc2018-symple1

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python automake autoconf libtool flex bison

    ## Build your planner
    cd /planner/planners/ipc2018-symple1
    ./build -j4

    strip --strip-all /planner/planners/ipc2018-symple1/src/preprocess/preprocess \
        /planner/planners/ipc2018-symple1/src/search/downward-1 \
        /planner/planners/ipc2018-symple1/src/search/downward-2 \
        /planner/planners/ipc2018-symple1/src/search/downward-4

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-symple2

%files
    planners/ipc2018-symple2 /planner/planners/ipc2018-symple2

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python-dev automake autoconf libtool flex bison unzip

    ## Build your planner
    cd /planner/planners/ipc2018-symple2
    ./build -j4

    strip --strip-all /planner/planners/ipc2018-symple2/src/preprocess/preprocess \
        /planner/planners/ipc2018-symple2/src/search/downward-1 \
        /planner/planners/ipc2018-symple2/src/search/downward-2 \
        /planner/planners/ipc2018-symple2/src/search/downward-4

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2014-opt-symba1

%files
    planners/ipc2014-opt-symba /planner/planners/ipc2014-opt-symba1

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends python cmake g++ g++-multilib make

    ## Build planner.
    cd /planner/planners/ipc2014-opt-symba1
    ./build -j4

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2014-opt-symba1/src/preprocess/preprocess \
        /planner/planners/ipc2014-opt-symba1/src/search/downward-1 \
        /planner/planners/ipc2014-opt-symba1/src/search/downward-2 \
        /planner/planners/ipc2014-opt-symba1/src/search/downward-4

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-opt-metis

%files
    planners/ipc2018-opt-metis /planner/planners/ipc2018-opt-metis

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python

    ## Build your planner
    cd /planner/planners/ipc2018-opt-metis
    ./build.py release64 -j4

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-opt-metis/builds/release64/bin/downward \
        /planner/planners/ipc2018-opt-metis/builds/release64/bin/preprocess

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-decstar

%files
    planners/ipc2018-decstar /planner/planners/ipc2018-decstar

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install g++ make python

    ## Build your planner
    cd /planner/planners/ipc2018-decstar/src
    ./build_all -j4

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-decstar/src/preprocess/preprocess
    strip --strip-all /planner/planners/ipc2018-decstar/src/search/downward-release

Bootstrap: docker
From: ubuntu:18.04
Stage: build-ipc2018-opt-planning-pdbs

%files
    planners/ipc2018-opt-planning-pdbs /planner/planners/ipc2018-opt-planning-pdbs

%post
    ## Install all necessary dependencies.
    apt-get update
    apt-get -y install --no-install-recommends cmake g++ make python autotools-dev automake gcc g++-multilib

    ## Build your planner
    cd /planner/planners/ipc2018-opt-planning-pdbs
    ./build.py release64 -j6

    ## Strip binaries.
    strip --strip-all /planner/planners/ipc2018-opt-planning-pdbs/builds/release64/bin/downward


Bootstrap: docker
From: ubuntu:18.04
Stage: build-learner-ibacop

# Copy planner binary and required files from Stage 1.
%files 
    learners/ibacop2 /planner/learners/ibacop2
       
%post
    ## Install only dependencies for running the planner.
    apt-get update
    apt-get install --no-install-recommends -y \
    	cmake\
     	make\
     	gcc-multilib \
     	flex \
     	bison \
     	g++-multilib \
     	gawk \
     	pypy\
     	python-pandas\
     	python-sklearn

    ## Build the planner
    cd /planner/learners/ibacop2
    MAKE_FLAGS="-j 6"
    export MAKE_FLAGS
    ./build

    strip --strip-all /planner/learners/ibacop2/src/features/ff-learner/roller3.0
    strip --strip-all /planner/learners/ibacop2/src/features/heuristics/preprocess/preprocess
    strip --strip-all /planner/learners/ibacop2/src/features/heuristics/search/downward-4
    strip --strip-all /planner/learners/ibacop2/src/features/preprocess/preprocess
    strip --strip-all /planner/learners/ibacop2/src/search-mercury/downward-4


Bootstrap: docker
From: ubuntu:18.04
Stage: run

%files from build-ipc2018-opt-scorpion
    /planner/planners/ipc2018-opt-scorpion/driver
    /planner/planners/ipc2018-opt-scorpion/fast-downward.py
    /planner/planners/ipc2018-opt-scorpion/builds/release64/bin
    /planner/planners/ipc2018-opt-scorpion/builds/h2-mutexes/bin/preprocess

%files from build-ipc2018-opt-complementary2
    /planner/planners/ipc2018-opt-complementary2/driver
    /planner/planners/ipc2018-opt-complementary2/fast-downward.py
    /planner/planners/ipc2018-opt-complementary2/builds/release64/bin

%files from build-ipc2018-opt-delfi
    /planner/planners/ipc2018-opt-delfi/driver
    /planner/planners/ipc2018-opt-delfi/fast-downward.py
    /planner/planners/ipc2018-opt-delfi/builds/release64/bin

%files from build-ipc2018-symple1
    /planner/planners/ipc2018-symple1/plan
    /planner/planners/ipc2018-symple1/src/plan
    /planner/planners/ipc2018-symple1/src/plan-ipc-18
    /planner/planners/ipc2018-symple1/src/translate
    /planner/planners/ipc2018-symple1/src/preprocess/preprocess
    /planner/planners/ipc2018-symple1/src/search/dispatch
    /planner/planners/ipc2018-symple1/src/search/downward
    /planner/planners/ipc2018-symple1/src/search/downward-1
    /planner/planners/ipc2018-symple1/src/search/downward-2
    /planner/planners/ipc2018-symple1/src/search/downward-4
    /planner/planners/ipc2018-symple1/src/search/unitcost

%files from build-ipc2018-symple2
    /planner/planners/ipc2018-symple2/plan
    /planner/planners/ipc2018-symple2/src/plan
    /planner/planners/ipc2018-symple2/src/plan-ipc-18
    /planner/planners/ipc2018-symple2/src/translate
    /planner/planners/ipc2018-symple2/src/preprocess/preprocess
    /planner/planners/ipc2018-symple2/src/search/dispatch
    /planner/planners/ipc2018-symple2/src/search/downward
    /planner/planners/ipc2018-symple2/src/search/downward-1
    /planner/planners/ipc2018-symple2/src/search/downward-2
    /planner/planners/ipc2018-symple2/src/search/downward-4
    /planner/planners/ipc2018-symple2/src/search/unitcost

%files from build-ipc2014-opt-symba1
    /planner/planners/ipc2014-opt-symba1/plan
    /planner/planners/ipc2014-opt-symba1/src/plan
    /planner/planners/ipc2014-opt-symba1/src/plan-ipc
    /planner/planners/ipc2014-opt-symba1/src/translate
    /planner/planners/ipc2014-opt-symba1/src/preprocess/preprocess
    /planner/planners/ipc2014-opt-symba1/src/search/downward
    /planner/planners/ipc2014-opt-symba1/src/search/downward-1
    /planner/planners/ipc2014-opt-symba1/src/search/downward-2
    /planner/planners/ipc2014-opt-symba1/src/search/downward-4
    /planner/planners/ipc2014-opt-symba1/src/search/dispatch
    /planner/planners/ipc2014-opt-symba1/src/search/unitcost

%files from build-ipc2018-opt-metis
    /planner/planners/ipc2018-opt-metis/fast-downward.py
    /planner/planners/ipc2018-opt-metis/builds/release64/bin/
    /planner/planners/ipc2018-opt-metis/driver

%files from build-ipc2018-decstar
    /planner/planners/ipc2018-decstar/src/driver
    /planner/planners/ipc2018-decstar/src/fast-downward.py
    /planner/planners/ipc2018-decstar/src/preprocess/preprocess
    /planner/planners/ipc2018-decstar/src/translate
    /planner/planners/ipc2018-decstar/src/search/downward-release

%files from build-ipc2018-opt-planning-pdbs
    /planner/planners/ipc2018-opt-planning-pdbs/fast-downward.py
    /planner/planners/ipc2018-opt-planning-pdbs/driver
    /planner/planners/ipc2018-opt-planning-pdbs/builds/release64/bin

%files from build-learner-ibacop
    /planner/learners/ibacop2/src/features/ff-learner/roller3.0
    /planner/learners/ibacop2/src/features/heuristics/training.sh
    /planner/learners/ibacop2/src/features/heuristics/translate
    /planner/learners/ibacop2/src/features/heuristics/preprocess/preprocess
    /planner/learners/ibacop2/src/features/heuristics/search/downward-4
    /planner/learners/ibacop2/src/features/preprocess/preprocess
    /planner/learners/ibacop2/src/features/translate
    /planner/learners/ibacop2/src/launcher
    /planner/learners/ibacop2/src/models
    /planner/learners/ibacop2/src/search-mercury/downward*
    /planner/learners/ibacop2/ibacop-features.sh

%files
    configs /planner/configs
    plan.py /planner/plan.py
    run-portfolio.py /planner/run-portfolio.py
    portfolio_driver /planner/portfolio_driver

%post
    apt-get update

    # requirements of all component planners
    apt-get -y install --no-install-recommends python software-properties-common time gawk python-pip
    # requirements of ibacop-features
    apt-get -y install --no-install-recommends python-pandas python-sklearn
    
    pip2 install -U wheel setuptools
    pip2 install networkx

    # requirements of delfi portfolio
    apt-get -y install --no-install-recommends python3

    # clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    #! /bin/bash
    set -euo pipefail

    DOMAINFILE="$1"
    PROBLEMFILE="$2"
    PLANFILE="$3"

    python3 /planner/run-portfolio.py \
        --alias hapori-ibacop2-opt \
        --overall-time-limit 30m \
        --plan-file "$PLANFILE" \
        "$DOMAINFILE" \
        "$PROBLEMFILE" \

%labels
Name        Hapori IBaCop2 Sat
Description Sequential portfolio of optimal IPC planners computed on an instance-based fashion. A set of 3 planners are pre-selected based on PDDL task and heuristic features.
Authors     Patrick Ferber <patrick.ferber@unibas.ch>, Michael Katz <michael.katz1@ibm.com>, Jendrik Seipp <jendrik.seipp@liu.se>, Silvan Sievers <silvan.sievers@unibas.ch>, Daniel Borrajo <dborrajo@ia.uc3m.es>, Isabel Cenamor <icenamorg@gmail.com>, Tomas de la Rosa <tomdelarosa@gmail.com>, Fernando Fernandez-Rebollo <ffernand@inf.uc3m.es>, Carlos Linares <clinares@inf.uc3m.es>, Sergio Nunez <sergio.nunez@repsol.com>, Alberto Pozanco <alberto.pozanco@gmail.com>, Horst Samulowitz <samulowitz@us.ibm.com>, Shirin Sohrabi <shirin.sohrabi@gmail.com>
License     GPL 3
Tracks      optimal
SupportsDerivedPredicates                       yes
SupportsUniversallyQuantifiedPreconditions      yes
SupportsExistentiallyQuantifiedPreconditions    yes
SupportsUniversallyQuantifiedEffects            yes
SupportsNegativePreconditions                   yes
SupportsEqualityPreconditions                   yes
SupportsInequalityPreconditions                 yes
SupportsConditionalEffects                      yes
SupportsImplyPreconditions                      yes
